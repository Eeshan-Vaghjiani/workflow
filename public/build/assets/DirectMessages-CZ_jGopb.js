import{r as l,j as e,a as N}from"./app-Cz-XC9l4.js";import{A as u,a as f,b as h}from"./avatar-DLZPR9xF.js";import{B as D}from"./button-Diu-54fO.js";import{I as A}from"./input-gyYvXWbp.js";import{S as I}from"./scroll-area-UkJwdiMs.js";import{u as P}from"./use-toast-LY2u_GWA.js";import{S as $}from"./search-CSzBP2dH.js";import"./index-MaZke14b.js";import"./index-BUtF6_nR.js";import"./index-BlXtbhPC.js";import"./index-CmyQNJFQ.js";import"./utils-CBfrqCZ4.js";import"./index-BdQq_4o_.js";import"./createLucideIcon-CfQhLZuM.js";function se({currentUserId:v}){const[w,o]=l.useState([]),[t,O]=l.useState(null),[g,p]=l.useState([]),[d,k]=l.useState(""),[T,F]=l.useState([]),[c,S]=l.useState(""),[R,j]=l.useState(!0),[U,y]=l.useState(!1),[x,b]=l.useState(!1),{toast:m}=P(),C=l.useRef(null);l.useEffect(()=>{(async()=>{try{j(!0);const n=await N.get("/chat/direct");o(n.data.conversations),F(n.data.users),j(!1)}catch(n){console.error("Error fetching conversations:",n),j(!1),m({title:"Error",description:"Failed to load conversations. Please try again.",variant:"destructive"})}})()},[m]),l.useEffect(()=>{if(t){(async()=>{try{y(!0);const r=await N.get(`/chat/direct/${t.id}`);p(r.data.messages),y(!1),o(a=>a.map(i=>i.user.id===t.id?{...i,unreadCount:0}:i))}catch(r){console.error("Error fetching messages:",r),y(!1),m({title:"Error",description:"Failed to load messages. Please try again.",variant:"destructive"})}})();const n=window.Echo.private(`chat.${v}`);return n.listen(".message.new",r=>{r.sender&&r.sender.id===t.id?(p(a=>[...a,r]),o(a=>a.map(i=>i.user.id===t.id?{...i,lastMessage:{content:r.content,timestamp:r.timestamp,date:r.date,is_read:!0,is_from_me:!1},unreadCount:0}:i))):r.sender&&o(a=>a.map(i=>i.user.id===r.sender?.id?{...i,lastMessage:{content:r.content,timestamp:r.timestamp,date:r.date,is_read:!1,is_from_me:!1},unreadCount:i.unreadCount+1}:i))}),()=>{n.stopListening(".message.new")}}},[t,v,m]),l.useEffect(()=>{C.current?.scrollIntoView({behavior:"smooth"})},[g]);const _=s=>{O(s),S("")},M=async()=>{if(!(!d.trim()||!t||x))try{b(!0);const s=await N.post(`/chat/direct/${t.id}`,{message:d});p(n=>[...n,s.data]),k(""),o(n=>{const r=n.map(a=>a.user.id===t.id?{...a,lastMessage:{content:d,timestamp:s.data.timestamp,date:s.data.date,is_read:!0,is_from_me:!0}}:a);return n.some(a=>a.user.id===t.id)||r.unshift({user:t,lastMessage:{content:d,timestamp:s.data.timestamp,date:s.data.date,is_read:!0,is_from_me:!0},unreadCount:0}),r}),b(!1)}catch(s){console.error("Error sending message:",s),b(!1),m({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"})}},E=c?T.filter(s=>s.name.toLowerCase().includes(c.toLowerCase())):[],L=c?w.filter(s=>s.user.name.toLowerCase().includes(c.toLowerCase())):w;return e.jsxs("div",{className:"flex h-full flex-col md:flex-row",children:[e.jsx("div",{className:"h-1/3 w-full border-b border-r border-gray-200 md:h-full md:w-80 md:flex-shrink-0 dark:border-gray-700",children:e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"relative",children:[e.jsx($,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500 dark:text-gray-400"}),e.jsx(A,{placeholder:"Search contacts...",className:"pl-8",value:c,onChange:s=>S(s.target.value)})]})}),e.jsxs(I,{className:"flex-1",children:[c&&E.length>0&&e.jsxs("div",{className:"p-2",children:[e.jsx("h3",{className:"mb-2 px-2 text-xs font-semibold text-gray-500 dark:text-gray-400",children:"CONTACTS"}),E.map(s=>e.jsxs("button",{className:"flex w-full items-center gap-2 rounded-md p-2 hover:bg-gray-100 dark:hover:bg-gray-800",onClick:()=>_(s),children:[e.jsxs(u,{className:"h-9 w-9",children:[e.jsx(f,{src:s.avatar||"",alt:s.name}),e.jsx(h,{children:s.name.substring(0,2)})]}),e.jsx("div",{className:"flex flex-1 flex-col items-start",children:e.jsx("span",{className:"font-medium",children:s.name})})]},s.id))]}),e.jsxs("div",{className:"p-2",children:[e.jsx("h3",{className:"mb-2 px-2 text-xs font-semibold text-gray-500 dark:text-gray-400",children:"CONVERSATIONS"}),R?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"h-5 w-5 animate-spin rounded-full border-t-2 border-gray-500"})}):L.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center p-4 text-center text-sm text-gray-500 dark:text-gray-400",children:[e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{children:"Start chatting with someone!"})]}):L.map(s=>e.jsxs("button",{className:`flex w-full items-center gap-2 rounded-md p-2 ${t?.id===s.user.id?"bg-gray-100 dark:bg-gray-800":"hover:bg-gray-100 dark:hover:bg-gray-800"}`,onClick:()=>_(s.user),children:[e.jsxs("div",{className:"relative",children:[e.jsxs(u,{className:"h-10 w-10",children:[e.jsx(f,{src:s.user.avatar||"",alt:s.user.name}),e.jsx(h,{children:s.user.name.substring(0,2)})]}),s.user.status==="online"&&e.jsx("span",{className:"absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-white bg-green-500 dark:border-gray-900"})]}),e.jsxs("div",{className:"flex flex-1 flex-col items-start",children:[e.jsxs("div",{className:"flex w-full justify-between",children:[e.jsx("span",{className:"font-medium",children:s.user.name}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:s.lastMessage.timestamp})]}),e.jsxs("div",{className:"flex w-full justify-between",children:[e.jsxs("span",{className:"truncate text-sm text-gray-500 dark:text-gray-400",children:[s.lastMessage.is_from_me?"You: ":"",s.lastMessage.content]}),s.unreadCount>0&&e.jsx("span",{className:"ml-2 flex h-5 w-5 items-center justify-center rounded-full bg-blue-500 text-xs text-white",children:s.unreadCount})]})]})]},s.user.id))]})]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:t?e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsxs("div",{className:"flex items-center border-b border-gray-200 p-4 dark:border-gray-700",children:[e.jsxs(u,{className:"h-10 w-10",children:[e.jsx(f,{src:t.avatar||"",alt:t.name}),e.jsx(h,{children:t.name.substring(0,2)})]}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"font-semibold",children:t.name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:t.status==="online"?"Online":"Offline"})]})]}),e.jsx(I,{className:"flex-1 p-4",children:U?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"h-5 w-5 animate-spin rounded-full border-t-2 border-gray-500"})}):g.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center text-sm text-gray-500 dark:text-gray-400",children:[e.jsx("p",{children:"No messages yet"}),e.jsx("p",{children:"Start a conversation!"})]}):e.jsxs("div",{className:"space-y-4",children:[g.map(s=>e.jsxs("div",{className:`flex ${s.is_from_me?"justify-end":"justify-start"}`,children:[!s.is_from_me&&s.sender&&e.jsxs(u,{className:"mr-2 h-8 w-8 self-end",children:[e.jsx(f,{src:s.sender.avatar||"",alt:s.sender.name}),e.jsx(h,{children:s.sender.name.substring(0,2)})]}),e.jsxs("div",{className:`max-w-xs rounded-lg px-4 py-2 ${s.is_from_me?"bg-blue-500 text-white":"bg-gray-100 text-gray-900 dark:bg-gray-800 dark:text-gray-100"}`,children:[e.jsx("p",{children:s.content}),e.jsx("span",{className:`mt-1 block text-xs ${s.is_from_me?"text-blue-100":"text-gray-500 dark:text-gray-400"}`,children:s.timestamp})]})]},s.id)),e.jsx("div",{ref:C})]})}),e.jsx("div",{className:"border-t border-gray-200 p-4 dark:border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{placeholder:"Type your message...",value:d,onChange:s=>k(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),M())},disabled:x,className:"flex-1"}),e.jsx(D,{onClick:M,disabled:x||!d.trim(),children:x?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}):"Send"})]})})]}):e.jsxs("div",{className:"flex h-full flex-col items-center justify-center text-center",children:[e.jsx("div",{className:"mb-4 rounded-full bg-gray-100 p-6 dark:bg-gray-800",children:e.jsx($,{className:"h-10 w-10 text-gray-500 dark:text-gray-400"})}),e.jsx("h3",{className:"text-lg font-semibold",children:"Select a conversation"}),e.jsx("p",{className:"mt-2 max-w-md text-gray-500 dark:text-gray-400",children:"Choose from your existing conversations or start a new one."})]})})]})}export{se as default};
